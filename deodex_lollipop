#!/bin/bash

# Do not edit this file unless you know what you are doing

base=$(pwd)
cd $base/tools

echo "----------------------------------------------------"
echo "-                                                  -"
echo "-            Deodex Lollipop for Linux             -"
echo "-                    by SuperR                     -"
echo "-                                                  -"
echo "----------------------------------------------------"
echo ""
if [ $(java -version 2>&1 | sed 's/java version "\(.*\)\.\(.*\)\..*"/\1\2/; 1q') -lt "17" ]; then
	echo "You need at least Java 7 to use this tool."
	read -p "Press ENTER to exit"
	exit
fi
if [ ! $(command -v 7za) ]; then
	echo "You need p7zip-full (7za) to use this tool."
	read -p "Press ENTER to exit"
	exit
fi
if [ ! -d "$base/system/framework" ]; then
	echo "MISSING FRAMEWORK:"
	echo "You must copy at least the framework directory from"
	echo "your ROM into the system directory located in the"
	echo "root of this tool."
	echo ""
	read -p "Press ENTER to Exit"
	exit
fi

echo "Type the arch of your device and press ENTER."
echo ""
echo "Hint: Check the framework directory, you should see"
echo "another directory inside. The name of it should go"
echo "here (ex. arm, arm64, x86)"
echo ""
read arch 
echo ""
echo "----------------------------------------------------"
echo ""
echo "Type the API level of the ROM and press ENTER."
echo ""
echo "Hint: 5.0.X = 21, 5.1.X = 22"
echo ""
read api
echo ""
echo ""

if [ ! -d "$base/system/framework/$arch" ]; then
	echo "ERROR:"
	echo "This tool cannot continue currently. Check the"
	echo "following:"
	echo ""
	echo "1. Make sure this is a Lollipop rom."
	echo "2. Make sure you typed the arch variable at the"
	echo "   beginning correctly."
	echo "3. Make sure your rom is not already deodexed."
	echo ""
	read -p "Press Enter to Exit"
	exit
fi

rm -rf $base/logs/*.log

echo "----------------------------------------------------"
echo "Start extracting boot.oat ..."
echo "----------------------------------------------------"
echo ""

if [ ! -d "$base/system/framework/$arch/odex" ]; then
	java -Xmx512m -jar oat2dex.jar boot $base/system/framework/$arch/boot.oat >> $base/logs/main.log
fi

echo ""
echo "----------------------------------------------------"
echo "Start deodexing /system/app ..."
echo "----------------------------------------------------"
echo ""
for app in $( ls $base/system/app ); do
	if [ -d "$base/system/app/$app/$arch" ]; then
		echo ""
		echo "... Deodexing $app"
		echo ""
		java -Xmx512m -jar oat2dex.jar $base/system/app/$app/$arch/$app.odex $base/system/framework/$arch/odex >> $base/logs/main.log
		java -Xmx512m -jar baksmali.jar -a $api -x $base/system/app/$app/$arch/$app.dex -o $base/system/app/$app/$arch/smali >> $base/logs/main.log
		java -Xmx512m -jar smali.jar -a $api $base/system/app/$app/$arch/smali -o $base/system/app/$app/$arch/classes.dex >> $base/logs/main.log
			if [ -f "$base/system/app/$app/$arch/$app-classes2.dex" ]; then
				java -Xmx512m -jar baksmali.jar -a $api -x $base/system/app/$app/$arch/$app-classes2.dex -o $base/system/app/$app/$arch/smali2 >> $base/logs/main.log
				java -Xmx512m -jar smali.jar -a $api $base/system/app/$app/$arch/smali2 -o $base/system/app/$app/$arch/classes2.dex >> $base/logs/main.log
			fi
			if [ -f "$base/system/app/$app/$arch/$app-classes3.dex" ]; then
				java -Xmx512m -jar baksmali.jar -a $api -x $base/system/app/$app/$arch/$app-classes3.dex -o $base/system/app/$app/$arch/smali3 >> $base/logs/main.log
				java -Xmx512m -jar smali.jar -a $api $base/system/app/$app/$arch/smali3 -o $base/system/app/$app/$arch/classes3.dex >> $base/logs/main.log
			fi
		7za u -tzip $base/system/app/$app/$app.apk $base/system/app/$app/$arch/classes*.dex >> $base/logs/zip.log
		rm -rf $base/system/app/$app/$arch
	else 
		echo "... $app is already deodexed"
	fi
done

echo ""
echo "----------------------------------------------------"
echo "Start deodexing /system/priv-app ..."
echo "----------------------------------------------------"
echo ""
for privapp in $( ls $base/system/priv-app ); do
	if [ -d "$base/system/priv-app/$privapp/$arch" ]; then
		echo ""
		echo "... Deodexing $privapp"
		echo ""
		java -Xmx512m -jar oat2dex.jar $base/system/priv-app/$privapp/$arch/$privapp.odex $base/system/framework/$arch/odex >> $base/logs/main.log
		java -Xmx512m -jar baksmali.jar -a $api -x $base/system/priv-app/$privapp/$arch/$privapp.dex -o $base/system/priv-app/$privapp/$arch/smali >> $base/logs/main.log
		java -Xmx512m -jar smali.jar -a $api $base/system/priv-app/$privapp/$arch/smali -o $base/system/priv-app/$privapp/$arch/classes.dex >> $base/logs/main.log
			if [ -f "$base/system/priv-app/$privapp/$arch/$privapp-classes2.dex" ]; then
				java -Xmx512m -jar baksmali.jar -a $api -x $base/system/priv-app/$privapp/$arch/$privapp-classes2.dex -o $base/system/priv-app/$privapp/$arch/smali2 >> $base/logs/main.log
				java -Xmx512m -jar smali.jar -a $api $base/system/priv-app/$privapp/$arch/smali2 -o $base/system/priv-app/$privapp/$arch/classes2.dex >> $base/logs/main.log
			fi
			if [ -f "$base/system/priv-app/$privapp/$arch/$privapp-classes3.dex" ]; then
				java -Xmx512m -jar baksmali.jar -a $api -x $base/system/priv-app/$privapp/$arch/$privapp-classes3.dex -o $base/system/priv-app/$privapp/$arch/smali3 >> $base/logs/main.log
				java -Xmx512m -jar smali.jar -a $api $base/system/priv-app/$privapp/$arch/smali3 -o $base/system/priv-app/$privapp/$arch/classes3.dex >> $base/logs/main.log
			fi
		7za u -tzip $base/system/priv-app/$privapp/$privapp.apk $base/system/priv-app/$privapp/$arch/classes*.dex >> $base/logs/zip.log
		rm -rf $base/system/priv-app/$privapp/$arch
	else 
		echo "... $privapp is already deodexed"
	fi
done

echo ""
echo "----------------------------------------------------"
echo "Start deodexing /system/framework ..."
echo "----------------------------------------------------"
echo ""
for framework in $( ls $base/system/framework/$arch | grep .odex | rev | cut -c 6- | rev ); do
	echo ""
	echo "... Deodexing $framework"
	echo ""
	java -Xmx512m -jar oat2dex.jar $base/system/framework/$arch/$framework.odex $base/system/framework/$arch/odex >> $base/logs/main.log
	java -Xmx512m -jar baksmali.jar -a $api -x $base/system/framework/$arch/$framework.dex -o $base/system/framework/$arch/smali >> $base/logs/main.log
	java -Xmx512m -jar smali.jar -a $api $base/system/framework/$arch/smali -o $base/system/framework/$arch/classes.dex >> $base/logs/main.log
		if [ -f "$base/system/framework/$arch/$framework-classes2.dex" ]; then
			java -Xmx512m -jar baksmali.jar -a $api -x $base/system/framework/$arch/$framework-classes2.dex -o $base/system/framework/$arch/smali2 >> $base/logs/main.log
			java -Xmx512m -jar smali.jar -a $api $base/system/framework/$arch/smali2 -o $base/system/framework/$arch/classes2.dex >> $base/logs/main.log
		fi
		if [ -f "$base/system/framework/$arch/$framework-classes3.dex" ]; then
			java -Xmx512m -jar baksmali.jar -a $api -x $base/system/framework/$arch/$framework-classes3.dex -o $base/system/framework/$arch/smali3 >> $base/logs/main.log
			java -Xmx512m -jar smali.jar -a $api $base/system/framework/$arch/smali3 -o $base/system/framework/$arch/classes3.dex >> $base/logs/main.log
		fi
	7za u -tzip $base/system/framework/$framework.jar $base/system/framework/$arch/classes*.dex >> $base/logs/zip.log
	rm -rf $base/system/framework/$arch/smali*
	rm -rf $base/system/framework/$arch/classes*.dex
done

for framework2 in $( ls $base/system/framework/$arch/dex | grep .dex | rev | cut -c 5- | rev ); do
	echo ""
	echo "... Deodexing $framework2"
	echo ""
	java -Xmx512m -jar baksmali.jar -a $api -x $base/system/framework/$arch/dex/$framework2.dex -o $base/system/framework/$arch/dex/smali >> $base/logs/main.log
	java -Xmx512m -jar smali.jar -a $api $base/system/framework/$arch/dex/smali -o $base/system/framework/$arch/dex/classes.dex >> $base/logs/main.log
		if [ -f "$base/system/framework/$arch/dex/$framework2-classes2.dex" ]; then
			java -Xmx512m -jar baksmali.jar -a $api -x $base/system/framework/$arch/dex/$framework2-classes2.dex -o $base/system/framework/$arch/dex/smali2 >> $base/logs/main.log
			java -Xmx512m -jar smali.jar -a $api $base/system/framework/$arch/dex/smali2 -o $base/system/framework/$arch/dex/classes2.dex >> $base/logs/main.log
		fi
		if [ -f "$base/system/framework/$arch/dex/$framework2-classes3.dex" ]; then
			java -Xmx512m -jar baksmali.jar -a $api -x $base/system/framework/$arch/dex/$framework2-classes3.dex -o $base/system/framework/$arch/dex/smali3 >> $base/logs/main.log
			java -Xmx512m -jar smali.jar -a $api $base/system/framework/$arch/dex/smali3 -o $base/system/framework/$arch/dex/classes3.dex >> $base/logs/main.log
		fi
	7za u -tzip $base/system/framework/$framework2.jar $base/system/framework/$arch/dex/classes*.dex >> $base/logs/zip.log
	rm -rf $base/system/framework/$arch/dex/smali*
	rm -rf $base/system/framework/$arch/dex/classes*.dex
done

echo ""
echo ""
echo "----------------------------------------------------"
echo "Cleaning up ..."
echo "----------------------------------------------------"
echo ""
echo ""
rm -rf $base/system/framework/$arch
rm -rf $base/system/framework/*classes2.jar
rm -rf $base/system/framework/*classes3.jar
echo ""
echo "----------------------------------------------------"
echo "Deodexing complete"
echo "----------------------------------------------------"
echo ""
echo ""
echo ""
echo "              -----------------------"
echo "              - Press ENTER to exit -"
echo "              -----------------------"
read -p ""
