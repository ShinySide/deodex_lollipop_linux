#!/bin/bash

# Do not edit this file unless you know what you are doing

framedir=$(pwd)/system/framework
appdir=$(pwd)/system/app
privdir=$(pwd)/system/priv-app
tools=$(pwd)/tools
logs=$(pwd)/logs

echo ""
echo ""
echo ""
echo ""
echo "----------------------------------------------------"
echo "-                                                  -"
echo "-            Deodex Lollipop for Linux             -"
echo "-                    by SuperR                     -"
echo "-                                                  -"
echo "----------------------------------------------------"
sleep 2
clear

if [ $(java -version 2>&1 | sed 's/java version "\(.*\)\.\(.*\)\..*"/\1\2/; 1q') -lt "17" ]; then
	echo ""
	echo "MISSING DEPENDENCY:"
	echo "You need at least Java 7 to use this tool."
	read -p "Press ENTER to exit"
	exit
fi
if [ ! $(command -v 7za) ]; then
	echo ""
	echo "MISSING DEPENDENCY:"
	echo "You need p7zip-full (7za) to use this tool."
	read -p "Press ENTER to exit"
	exit
fi
if [ ! -d "$framedir" ]; then
	echo ""
	echo "MISSING FRAMEWORK:"
	echo "You must copy at least the framework directory from"
	echo "your ROM into the system directory located in the"
	echo "root of this tool."
	echo ""
	read -p "Press ENTER to Exit"
	exit
fi

arch=""
while [[ ! -f $framedir/$arch/boot.oat ]]; do
	echo ""
	echo "Configure the arch of your device."
	echo ""
	echo "HINT:"
	echo "Check the framework directory, you should see"
	echo "another directory inside. The name of it should go"
	echo "here (ex. arm, arm64, x86)."
	echo ""
	echo "If you can't get past this part, check the"
	echo "following:"
	echo ""
	echo "1. Make sure this is a Lollipop rom."
	echo "2. Make sure you typed the arch variable correctly."
	echo "3. Make sure your rom is not already deodexed."
	echo ""
	echo "Type the arch of your device and press ENTER."
	echo ""
	read arch 
	clear
done

api=""
while [[ $api -lt "21" || $api -gt "22" ]] ; do
	echo ""
	echo "Type the API level of the ROM and press ENTER."
	echo ""
	echo "HINT:"
	echo "5.0.x = 21"
	echo "5.1.x = 22"
	echo ""
	read api
	clear
done

rm -rf $logs/*.log

echo ""
echo "----------------------------------------------------"
echo "Deoptimizing boot.oat ..."
echo "----------------------------------------------------"
echo ""

cd $tools
if [ ! -d "$framedir/$arch/odex" ]; then
	java -Xmx512m -jar oat2dex.jar boot $framedir/$arch/boot.oat >> $logs/main.log
fi
clear

echo ""
echo "----------------------------------------------------"
echo "Start deodexing /system/app ..."
echo "----------------------------------------------------"
echo ""

app=""
for app in $( ls $appdir ); do
	if [ -f "$appdir/$app/$arch/$app.odex.gz" ]; then
		cd $appdir/$app/$arch
		echo ""
		echo "... Extracting $app.odex.gz"
		echo ""
		7za e "$appdir/$app/$arch/$app.odex.gz" >> $logs/zip.log
	fi
done

cd $tools
app=""
for app in $( ls $appdir ); do
	if [ -d "$appdir/$app/$arch" ]; then
		echo ""
		echo "... Deodexing $app"
		echo ""
		java -Xmx512m -jar oat2dex.jar $appdir/$app/$arch/$app.odex $framedir/$arch/odex >> $logs/main.log
		mv $appdir/$app/$arch/$app.dex $appdir/$app/$arch/classes.dex
			if [ -f "$appdir/$app/$arch/$app-classes2.dex" ]; then
				mv $appdir/$app/$arch/$app-classes2.dex $appdir/$app/$arch/classes2.dex
			fi
			if [ -f "$appdir/$app/$arch/$app-classes3.dex" ]; then
				mv $appdir/$app/$arch/$app-classes3.dex $appdir/$app/$arch/classes3.dex
			fi
		7za u -tzip $appdir/$app/$app.apk $appdir/$app/$arch/classes*.dex >> $logs/zip.log
		rm -rf $appdir/$app/$arch
	else 
		echo "... $app is already deodexed"
	fi
done
clear

echo ""
echo "----------------------------------------------------"
echo "Start deodexing /system/priv-app ..."
echo "----------------------------------------------------"
echo ""

privapp=""
for privapp in $( ls $privdir ); do
	if [ -f "$privdir/$privapp/$arch/$privapp.odex.gz" ]; then
		cd $privdir/$privapp/$arch
		echo ""
		echo "... Extracting $privapp.odex.gz"
		echo ""
		7za e "$privdir/$privapp/$arch/$privapp.odex.gz" >> $logs/zip.log
	fi
done

cd $tools
privapp=""
for privapp in $( ls $privdir ); do
	if [ -d "$privdir/$privapp/$arch" ]; then
		echo ""
		echo "... Deodexing $privapp"
		echo ""
		java -Xmx512m -jar oat2dex.jar $privdir/$privapp/$arch/$privapp.odex $framedir/$arch/odex >> $logs/main.log
		mv $privdir/$privapp/$arch/$privapp.dex $privdir/$privapp/$arch/classes.dex
			if [ -f "$privdir/$privapp/$arch/$privapp-classes2.dex" ]; then
				mv $privdir/$privapp/$arch/$privapp-classes2.dex $privdir/$privapp/$arch/classes2.dex
			fi
			if [ -f "$privdir/$privapp/$arch/$privapp-classes3.dex" ]; then
				mv $privdir/$privapp/$arch/$privapp-classes3.dex $privdir/$privapp/$arch/classes3.dex
			fi
		7za u -tzip $privdir/$privapp/$privapp.apk $privdir/$privapp/$arch/classes*.dex >> $logs/zip.log
		rm -rf $privdir/$privapp/$arch
	else 
		echo "... $privapp is already deodexed"
	fi
done
clear

echo ""
echo "----------------------------------------------------"
echo "Start deodexing /system/framework ..."
echo "----------------------------------------------------"
echo ""

for frame in $( ls $framedir/$arch | grep .odex | rev | cut -c 6- | rev ); do
	echo ""
	echo "... Deodexing $frame"
	echo ""
	java -Xmx512m -jar oat2dex.jar $framedir/$arch/$frame.odex $framedir/$arch/odex >> $logs/main.log
	mv $framedir/$arch/$frame.dex $framedir/$arch/classes.dex
		if [ -f "$framedir/$arch/$frame-classes2.dex" ]; then
			mv $framedir/$arch/$frame-classes2.dex $framedir/$arch/classes2.dex
		fi
		if [ -f "$framedir/$arch/$frame-classes3.dex" ]; then
			mv $framedir/$arch/$frame-classes3.dex $framedir/$arch/classes3.dex
		fi
	7za u -tzip $framedir/$frame.jar $framedir/$arch/classes*.dex >> $logs/zip.log
	rm -rf $framedir/$arch/classes*.dex
done
for frame2 in $( ls $framedir/$arch/dex | grep .dex | rev | cut -c 5- | rev ); do
	if [[ $frame2 != *"classes"* ]]; then
		echo ""
		echo "... Deodexing $frame2"
		echo ""
		mv $framedir/$arch/dex/$frame2.dex $framedir/$arch/dex/classes.dex
			if [ -f "$framedir/$arch/dex/$frame2-classes2.dex" ]; then
				mv $framedir/$arch/dex/$frame2-classes2.dex $framedir/$arch/dex/classes2.dex
			fi
			if [ -f "$framedir/$arch/dex/$frame2-classes3.dex" ]; then
				mv $framedir/$arch/dex/$frame2-classes3.dex $framedir/$arch/dex/classes3.dex
			fi
		7za u -tzip $framedir/$frame2.jar $framedir/$arch/dex/classes*.dex >> $logs/zip.log
		rm -rf $framedir/$arch/dex/classes*.dex
	fi
done
clear

echo ""
echo "----------------------------------------------------"
echo "Cleaning up ..."
echo "----------------------------------------------------"
echo ""
echo ""
rm -rf $framedir/$arch
clear
echo ""
echo "----------------------------------------------------"
echo "Deodexing complete"
echo "----------------------------------------------------"
echo ""
echo ""
echo ""
echo "              -----------------------"
echo "              - Press ENTER to exit -"
echo "              -----------------------"
read -p ""
